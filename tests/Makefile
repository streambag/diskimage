
CFLAGS+=	-I ../libdiskimage/
CFLAGS+=	-g

TESTS=	vhdfooter_test vmdkdescriptorfile_test vmdkextentdescriptor_test
TEST_SOURCES=	${TESTS:S/$/.c/}

HELPER_SOURCES=	memorytest.c
HELPER_OBJFILES=	${HELPER_SOURCES:S/.c$/.o/}

TESTS_LDFLAGS= ${LDFLAGS} -L /usr/local/lib -latf-c
TESTS_LDLIBS= ${LDLIBS} ${HELPER_OBJFILES}

DEPENDFILE=	.depend

CLEANFILES+=	${TESTS} ${HELPER_OBJFILES} ${DEPENDFILE} Kyuafile

all: ${TESTS} Kyuafile

${TESTS}: ${.TARGET}.c ${HELPER_OBJFILES}
	${CC} ${CFLAGS} ${TESTS_LDFLAGS} ${.IMPSRC} ${TESTS_LDLIBS} -o ${.TARGET}

Kyuafile: Makefile
	@{ \
	    echo '-- Automatically generated by Makefile.'; \
	    echo; \
	    echo 'syntax(2)'; \
	    echo; \
	    echo 'test_suite("diskimage")'; \
	    echo; \
	} > Kyuafile
.for T in ${TESTS}
	@echo 'atf_test_program{name="${T}"}' >> Kyuafile
.endfor

depend: .depend

.depend:
	@rm ${DEPENDFILE} 2>/dev/null || true
	mkdep -p -a -f ${DEPENDFILE} ${CFLAGS} ${TEST_SOURCES}
	mkdep -a -f ${DEPENDFILE} ${CFLAGS} ${HELPER_SOURCES}


clean:
	@rm ${CLEANFILES} 2>/dev/null || true

-include ".depend"
